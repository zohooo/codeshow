% -*- coding: utf-8 -*-

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{codeshow}[2014/07/05 v0.0.1 Show code and its result]
\RequirePackage{verbatim,xcolor}

\newbox\savedlines
\newtoks\savedtokens

\def\codeshow{%
  \global\setbox\savedlines=\vbox{}%
  \global\savedtokens={}%
  \def\verbatim@processline{%
    \global\setbox\savedlines=\vbox{\unvbox\savedlines\hbox{\the\verbatim@line}}%
    \global\savedtokens=\expandafter{\the\expandafter\savedtokens\the\verbatim@line^^J}}%
  \verbatim}
\def\endcodeshow{\endverbatim%
  \vspace{1em}\par\noindent%
  \colorbox{lightgray}{%
    \begin{minipage}{.55\textwidth}{\usebox\savedlines}\end{minipage}}%
  \hfill\fbox{\parbox{.40\textwidth}%
    {\scantokens\expandafter{\the\savedtokens\unskip\endinput}}}%
  \vspace{1em}\par}
